<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Mascotas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg bg-primary navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Mansa Mascota</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="#">Mascotas</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Dueños</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gestión de Mascotas</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
            <i class="bi bi-plus"></i> Nueva Mascota
        </button>
    </div>

    <!-- Tabla de Mascotas -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-primary">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Especie</th>
                    <th>Raza</th>
                    <th>Edad</th>
                    <th>Género</th>
                    <th>Dueño</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tableMascotas">
            </tbody>
        </table>
    </div>

    <!-- Modal para Crear Mascota -->
    <div class="modal fade" id="createModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Mascota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="mb-3">
                            <label for="createNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="createNombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="createEspecie" class="form-label">Especie</label>
                            <input type="text" class="form-control" id="createEspecie" required>
                        </div>
                        <div class="mb-3">
                            <label for="createRaza" class="form-label">Raza</label>
                            <input type="text" class="form-control" id="createRaza" required>
                        </div>
                        <div class="mb-3">
                            <label for="createEdad" class="form-label">Edad</label>
                            <input type="number" class="form-control" id="createEdad" required>
                        </div>
                        <div class="mb-3">
                            <label for="createGenero" class="form-label">Género</label>
                            <select class="form-select" id="createGenero" required>
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="createDueno" class="form-label">Dueño</label>
                            <select class="form-select" id="createDueno" required>
                                <!-- Se llenará dinámicamente -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createMascota()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Mascota -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Mascota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="mb-3">
                            <label for="editNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="editNombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEspecie" class="form-label">Especie</label>
                            <input type="text" class="form-control" id="editEspecie" required>
                        </div>
                        <div class="mb-3">
                            <label for="editRaza" class="form-label">Raza</label>
                            <input type="text" class="form-control" id="editRaza" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEdad" class="form-label">Edad</label>
                            <input type="number" class="form-control" id="editEdad" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGenero" class="form-label">Género</label>
                            <select class="form-select" id="editGenero" required>
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDueno" class="form-label">Dueño</label>
                            <select class="form-select" id="editDueno" required>
                                <!-- Se llenará dinámicamente -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="updateMascota()">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Eliminar -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea eliminar esta mascota?</p>
                    <input type="hidden" id="deleteId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="deleteMascota()">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
// Configuración de la URL base de la API
const BASE_URL = 'http://localhost:3000';
let duenos = [];

// Función para cargar los dueños
async function loadDuenos() {
    try {
        const response = await fetch(`${BASE_URL}/duenos`);
        duenos = await response.json();
        
        // Llenar los select de dueños en ambos modales
        const createSelect = document.getElementById('createDueno');
        const editSelect = document.getElementById('editDueno');
        
        const duenosHTML = duenos.map(dueno => 
            `<option value="${dueno.id}">${dueno.nombre} ${dueno.apellido}</option>`
        ).join('');
        
        createSelect.innerHTML = duenosHTML;
        editSelect.innerHTML = duenosHTML;
    } catch (error) {
        console.error('Error al cargar dueños:', error);
        alert('Error al cargar la lista de dueños');
    }
}

// Función para cargar las mascotas
async function loadMascotas() {
    try {
        const response = await fetch(`${BASE_URL}/mascotas`);
        const mascotas = await response.json();
        const tableBody = document.getElementById('tableMascotas');
        tableBody.innerHTML = '';
        
        mascotas.forEach(mascota => {
            const dueno = duenos.find(d => d.id === mascota.id_dueno);
            tableBody.innerHTML += `
                <tr>
                    <td>${mascota.id}</td>
                    <td>${mascota.nombre}</td>
                    <td>${mascota.especie}</td>
                    <td>${mascota.raza}</td>
                    <td>${mascota.edad}</td>
                    <td>${mascota.genero}</td>
                    <td>${dueno ? `${dueno.nombre} ${dueno.apellido}` : 'No asignado'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="prepareEdit(${JSON.stringify(mascota)})">
                            Editar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="prepareDelete(${mascota.id})">
                            Eliminar
                        </button>
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Error al cargar mascotas:', error);
        alert('Error al cargar las mascotas');
    }
}

// Función para crear una nueva mascota
async function createMascota() {
    const mascota = {
        nombre: document.getElementById('createNombre').value,
        especie: document.getElementById('createEspecie').value,
        raza: document.getElementById('createRaza').value,
        edad: parseInt(document.getElementById('createEdad').value),
        genero: document.getElementById('createGenero').value,
        id_dueno: parseInt(document.getElementById('createDueno').value)
    };

    try {
        const response = await fetch(`${BASE_URL}/mascotas`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mascota)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
            document.getElementById('createForm').reset();
            loadMascotas();
            alert('Mascota creada exitosamente');
        } else {
            alert('Error al crear la mascota');
        }
    } catch (error) {
        console.error('Error al crear mascota:', error);
        alert('Error al crear la mascota');
    }
}

// Función para preparar la edición
function prepareEdit(mascota) {
    document.getElementById('editId').value = mascota.id;
    document.getElementById('editNombre').value = mascota.nombre;
    document.getElementById('editEspecie').value = mascota.especie;
    document.getElementById('editRaza').value = mascota.raza;
    document.getElementById('editEdad').value = mascota.edad;
    document.getElementById('editGenero').value = mascota.genero;
    document.getElementById('editDueno').value = mascota.id_dueno;
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

// Función para actualizar una mascota
async function updateMascota() {
    const id = document.getElementById('editId').value;
    const mascota = {
        nombre: document.getElementById('editNombre').value,
        especie: document.getElementById('editEspecie').value,
        raza: document.getElementById('editRaza').value,
        edad: parseInt(document.getElementById('editEdad').value),
        genero: document.getElementById('editGenero').value
    };

    try {
        const response = await fetch(`${BASE_URL}/mascotas/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(mascota)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            loadMascotas();
            alert('Mascota actualizada exitosamente');
        } else {
            alert('Error al actualizar la mascota');
        }
    } catch (error) {
        console.error('Error al actualizar mascota:', error);
        alert('Error al actualizar la mascota');
    }
}

// Función para preparar la eliminación
function prepareDelete(id) {
    document.getElementById('deleteId').value = id;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Función para eliminar una mascota
async function deleteMascota() {
    const id = document.getElementById('deleteId').value;

    try {
        const response = await fetch(`${BASE_URL}/mascotas/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadMascotas();
            alert('Mascota eliminada exitosamente');
        } else {
            alert('Error al eliminar la mascota');
        }
    } catch (error) {
        console.error('Error al eliminar mascota:', error);
        alert('Error al eliminar la mascota');
    }
}

// Cargar dueños y mascotas al iniciar la página
document.addEventListener('DOMContentLoaded', async () => {
    await loadDuenos();
    await loadMascotas();
});
</script>

</body>
</html>